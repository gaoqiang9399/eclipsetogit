//download by http://sc.xueit.com
var hoverIndex = -1;
var hoverFlag = false;
var clkFlag = false;
var postion = {};
(function($) {
    $.fn.lavaLamp = function(o) {
        o = $.extend({
            fx: "linear",
            speed: 500,
            click: function() {}
        }, o || {});
        return this.each(function() {
            var b = $(this)
              , noop = function() {}
              , $back = $('<li class="back"><div class="left"></div></li>').appendTo(b)
              , $li = $("li", this)
              , curr = $("li.current-cat", this)[0] || $($li[0]).addClass("current-cat")[0];
              $.each($li.not(".back"),function(index,node){
            	  var wrapper_content_height = 0;
                  var len = $(".wrapper-content ul").eq(index).find("li").length;
                  if (len > 0) {
                      wrapper_content_height = ($(".wrapper-content ul").eq(index).find("li").eq(0).outerHeight(true)) * len;//子菜单UL 高度
                      $(".wrapper-ul-curr").css("border-top","1px solid #ddd");
                  } else {
                      wrapper_content_height = 0;
                      $(".wrapper-ul-curr").css("border-top","none");
                      $(".wrapper-content ul").css("padding", "0px");
                      $(".wrapper-content ul").eq(index).css("opacity","0");
                  }
                  $(".wrapper-content ul").eq(index).css("height", wrapper_content_height + "px");
              })
            $li.not(".back").hover(function() {
            	var index = $(this).index();
                move(this, true);
                if (!o.wrapper) {
                    return;
                }
                clkFlag = false;
                hoverFlag = true;
                $(".wrapper-content ul").css("background-color", "");
                $(".wrapper-content ul").removeClass("wrapper-ul-curr");
                $(".wrapper-content ul").eq(index).css({"background-color":"rgba(255,255, 255, 1)"});
                $(".wrapper-content ul").eq(index).addClass("wrapper-ul-curr");
                $(".wrapper-content ul").addClass("hiden_li");
                $(".wrapper-content ul").eq(index).removeClass("hiden_li");
                if (hoverFlag && !$(".wrapper-content").hasClass("hided")) {
                    $(".wrapper-content").css({
                        height: "100%",
                        "background-color": "rgba(255, 255, 255, 0)"
                    }).show();
                } else {
                    $(".wrapper-content").removeClass("hided");
                    $(".wrapper-content").hide();
                }
                $(".wrapper-content ul").eq(index).css({
                	"top":"0px",
                	"left":$(this).offset().left+"px",
                	"position":"absolute"
                });
            }, noop);
            $(this).hover(noop, function() {
                if (clkFlag) {
                    $back.each(function() {
                        $(this).dequeue()
                    }).animate({
                        width: postion.width,
                        left: postion.left
                    }, o.speed, o.fx)
                } else {
                    move(curr)
                }
                hoverFlag = false;
                $(".wrapper-content ul").css("background-color", "");
                if (!hoverFlag) {
                    $(".wrapper-content").hide();
                }
            });
            $(".wrapper-content ul").hover(function() {
            	$(this).addClass("wrapper-ul-curr").removeClass("hiden_li");
            	$(this).siblings('ul').removeClass("wrapper-ul-curr").addClass("hiden_li");
                hoverFlag = true;
                $(".wrapper-content").show();
                move($(".lavaLamp").find("li")[$(this).index()], true);
                $(".lavaLamp").find("li").eq($(this).index()).css({
                    "background-color": "#FFFFFF",
                    "border-left": "1px solid #DDDDDD",
                    "border-right": "1px solid #DDDDDD",
                });
            }, function() {
                hoverFlag = false;
                move(curr);
                $(".lavaLamp li").css({
                    "background-color": "",
                    "border-left": "",
                    "border-right": ""
                });
                if (!hoverFlag) {
                	$(".wrapper-content").hide();
                }
            });
            $(".wrapper-content ul li").hover(function() {// alert($(this).html())
            }, function() {});
            $(".wrapper-content ul li").click(function(){
            	var i = $(this).parent().index();
            	setCurr($li.eq(i)[0]);
            });
            $li.click(function(e) {
                setCurr(this);
                return o.click.apply(this, [e, this]);
            });
            setCurr(curr);
            function setCurr(a) {
                if (a.offsetWidth == 0)
                    a.offsetWidth = 100;
                $back.css({
                    "left": a.offsetLeft + "px",
                    "width": a.offsetWidth + "px"
                });
                curr = a;
            }
            function move(a, flag) {
                $back.each(function() {
                    $(this).dequeue()
                }).css({
                    opacity: 1,
                    "border-left": "1px solid #DDDDDD",
                    "border-right": "1px solid #DDDDDD",
                    "background-color": ""
                }).stop().animate({
                    width: a.offsetWidth,
                    left: a.offsetLeft
                }, o.speed, o.fx, function() {
                    if (flag) {
                        $back.animate({// opacity:'0'
                        }).css({
                            "background-color": "#ffffff"
                        });
                    } else {
                        $back.css({
                            opacity: 1
                        });
                    }
                });
            }
        })
    }
})(jQuery)
